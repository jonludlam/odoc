<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
 <head><title>contributing (odoc.contributing)</title>
  <link rel="stylesheet" href="odoc.css"/><meta charset="utf-8"/>
  <meta name="generator" content="odoc %%VERSION%%"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <script src="highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
 </head>
 <body class="odoc">
  <nav class="odoc-nav"><a href="index.html">Up</a> â€“ 
   <a href="index.html">odoc</a> &#x00BB; contributing
  </nav>
  <header class="odoc-preamble">
   <h1 id="contributing-to-odoc">
    <a href="#contributing-to-odoc" class="anchor"></a>Contributing to
     odoc
   </h1>
   <p>Please ask any questions you have about odoc, 
    <a href="https://github.com/ocaml/odoc/issues">open any issues</a>
    , <a href="https://github.com/ocaml/odoc#contact">offer feedback</a>
    , etc. All of these are valued contributions :)
   </p>
   <p>If you'd like specifically to work on the code of odoc, we hope
     that you will find the information in this file helpful.
   </p>
  </header>
  <nav class="odoc-toc">
   <ul>
    <li><a href="#quick-start:-html-and-css">Quick start: HTML and CSS</a>
    </li>
    <li><a href="#testing">Testing</a>
     <ul><li><a href="#cram-tests">Cram tests</a></li>
      <li><a href="#other-expect-tests">Other expect tests</a></li>
     </ul>
    </li><li><a href="#coverage-analysis">Coverage analysis</a></li>
    <li><a href="#ci-tests">CI tests</a></li>
    <li><a href="#project-structure">Project structure</a></li>
   </ul>
  </nav>
  <div class="odoc-content">
   <h2 id="quick-start:-html-and-css">
    <a href="#quick-start:-html-and-css" class="anchor"></a>Quick start:
     HTML and CSS
   </h2>
   <p>The odoc CSS is found at 
    <a href="https://github.com/ocaml/odoc/blob/master/src/odoc/etc/odoc.css">
     src/odoc/etc/css
    </a>. It still needs a lot of work, and PRs are very welcome. You
     can edit CSS using your browser's developer mode, then send us a
     PR for the same changes made to this file.
   </p>
   <p>Working on the HTML is more involved. The main HTML generator is
     in 
    <a href="https://github.com/ocaml/odoc/blob/master/src/html/generator.ml">
     src/html/generator.ml
    </a>. It operates on the types defined in 
    <a href="odoc_document/Odoc_document/Types/index.html">
     <code>Odoc_document.Types</code>
    </a>, which is an intermediate representation used by all output 
    renderers. The type that describes an individual HTML page is 
    <a href="odoc_document/Odoc_document/Types/Page/index.html#type-t">
     <code>Odoc_document.Types.Page.t</code>
    </a>.
   </p>
   <p>To make edits to the HTML generation, run the following commands:</p>
   <ol>
    <li><p>Install requirements:</p>
     <ul>
      <li>
       <p>A recent version of 
        <a href="http://www.html-tidy.org/">HTML tidy</a> (used for HTML
         validity testing) is required:
       </p>
       <pre>
        <code>
         # On MacOS (should be version 5.6.0 by the date of this writing)
         brew install tidy-html5     
         # Debian / Ubuntu
         sudo apt-get install tidy
        </code>
       </pre>
      </li>
      <li>
       <p>A recent version of <a href="https://github.com/stedolan/jq">jq</a>
         is required.
       </p>
       <pre>
        <code>
         # On MacOS
         brew install jq
         
         # Debian / Ubuntu
         sudo apt-get install jq
        </code>
       </pre>
      </li>
     </ul>
    </li>
    <li><p>Set up for development:</p>
     <pre>
      <code>
       git clone https://github.com/ocaml/odoc.git
       cd odoc
       opam pin add --no-action odoc .
       opam install --with-test --deps-only odoc
       opam install mdx
      </code>
     </pre>
    </li>
    <li><p>Make changes to the code. To compile it,</p>
     <pre><code>make</code></pre><p>and then to run the tests,</p>
     <pre><code>make test</code></pre>
     <p>Changes to the HTML are likely to cause the tests to fail. See
       the section <a href="#testing">Testing</a> below to understand
       how to update them.
     </p>
    </li>
    <li><p>To test odoc against your own project, install it</p>
     <pre><code>make clean
                opam install odoc</code></pre>
     <p>Since odoc is pinned, this installs your modified version. Then,
       you can run odoc in your project as normal:
     </p><pre><code>dune build @doc</code></pre>
    </li><li>If all looks good, send odoc a PR :)</li>
   </ol><h2 id="testing"><a href="#testing" class="anchor"></a>Testing</h2>
   <p>odoc uses a variety of different test types. We are slowly converging
     on using dune's <em>cram tests</em>, though we still have many tests
     that aren't.
   </p>
   <h3 id="cram-tests"><a href="#cram-tests" class="anchor"></a>Cram tests
   </h3>
   <p>These are extensively used by the tests for the model layer, and
     are found in <em>test/xref2</em>. These consist of a directory called
     <code>something.t</code>, containing a file <code>run.t</code>. 
    This file contains shell-like syntax, and usually runs odoc on some
     carefully crafted input files. For tests of the model layer it's
     often useful to use the binary `odoc_print` which can dump 
    <code>odoc</code> and <code>odocl</code> files as JSON. This output
     can then be piped through <code>jq</code> to verify that values 
    are as expected.
   </p>
   <p>We try to make these test files describe the test and what's expected
     which helps both when the output is not what the test expects, and
     also means that the tests can serve as documentation of how things
     work. As an example see the file 
    <em>test/xref2/multi_file_module_type_of.t/run.t</em>
   </p>
   <p>The tests work by executing the shell script snippets, and then
     comparing the output we actually get with those in the 
    <code>run.t</code> files. If these _don't_ match, the difference 
    is rendered as a <code>diff</code>. For example, if I change the 
    way <code>type</code> declarations are printed and run 
    <code>dune runtest</code>, I get the following output:
   </p>
   <pre>
    <code>
     ------ test/xref2/module_type_of.t/run.t
     ++++++ test/xref2/module_type_of.t/run.t.corrected
     File &quot;test/xref2/module_type_of.t/run.t&quot;, line 95, characters
     0-1:
      |                ]
      |              },
      |              &quot;T&quot;
      |            ]
      |          },
      |          &quot;Z&quot;
      |        ]
      |      }
      |    }
      |  ]
      |
      |Check that the expansion of 'T.Y' contains only 1 type
      |
      |  $ jq
     &quot;.[0].ModuleType.expr.Some.TypeOf.t_expansion.Some.Signature.items&quot;
     &lt; T_sig.json &gt; T.Y_sig.json
      |  $ odoc_print m.odocl | jq &quot;map(keys | .[0])&quot; &lt;
     T.Y_sig.json
      |  [
     -|    &quot;Type&quot;
     +|    &quot;Toupe&quot;
      |  ]
      |
    </code>
   </pre><p>The intended response to this is:</p>
   <ol>
    <li>Check the diff. If the `-` line is correct, the code is broken.
      If the `+` line is correct, the test is broken.
    </li>
    <li>If the test is broken, run <code>dune promote</code> to replace
      the expected output with the current output.
    </li>
   </ol>
   <h3 id="other-expect-tests">
    <a href="#other-expect-tests" class="anchor"></a>Other expect tests
   </h3>
   <p>Many of odoc's older tests are <b>custom expect tests</b>, similar
     to those run in the cram test above, but that don't use dune's 
    <code>promote</code> workflow. As an example the parser tests in 
    <code>test/parser</code> work in the following way:
   </p>
   <ol>
    <li>The tests run some code, for example the odoc parser on the string
      <code>{e foo}</code>.
    </li>
    <li>They take the output, in this case an AST representing 
     &quot;emphasized <code>foo</code>,&quot; and convert that output
      to a string. In this case, it will be an S-expression roughly like
      `(emphasis (foo))`.
    </li>
    <li>There is an <b>expected</b> copy of this S-expression in a file
      somewhere in the repo. If the S-expression from the code doesn't
      match the expected one, the test fails.
    </li>
   </ol>
   <p>When one of these expect test fails, the string that the code emitted
     is saved, so that the human developer can choose to <b>replace</b>
     the now-incorrect expected string. For these custom expect tests,
     the results may look like:
   </p>
   <pre>
    <code>
     -- bold.000 [basic.] Failed --
     in _build/_tests/bold.000.output:
     
     {e foo}
     
     --- expect/bold/basic.txt       2018-04-15 14:42:32.356895400 -0500
     +++ _actual/bold/basic.txt      2018-04-15 17:36:26.812747400 -0500
     @@ -2,5 +2,5 @@
        (ok
         (((f.ml (1 0) (1 7))
           (paragraph
     -      (((f.ml (1 0) (1 7)) (bold (((f.ml (1 3) (1 6)) (word
     foo)))))))))))
     +      (((f.ml (1 0) (1 7)) (emphasis (((f.ml (1 3) (1 6)) (word
     foo)))))))))))
       (warnings ()))
     
     To replace expected output with actual, run
     
     bash _build/default/test/parser/_actual/replace.sh
    </code>
   </pre>
   <p>As with the cram tests, the idea is to examine the diff to see 
    if your code is broken or the test is broken. If the test is broken,
     the actual results may be promoted to the expected results by running
     the suggested command. If your code is broken, go and fix it!
   </p>
   <p>We are slowly shifting these custom expect tests over to the dune
     promote workflow.
   </p>
   <h2 id="coverage-analysis">
    <a href="#coverage-analysis" class="anchor"></a>Coverage analysis
   </h2>
   <p>The odoc repo is set up for coverage analysis. This is most useful
     if you're writing new tests, and want to know what they are actually
     touching. To use it,
   </p>
   <ol>
    <li>
     <p>Run `make coverage`. This will run the tests as normal, except
       at the end you will get a message like
     </p><pre><code>See _coverage/index.html</code></pre>
     <p>You can then open <code>_coverage/index.html</code> and see the
       coverage of the code you would like your new test to reach. It
       is possible that it is already covered &quot;accidentally&quot;
       by tests that are checking other properties, however, in which
       case coverage analysis will not be very useful :)
     </p>
    </li><li>Write new tests.</li><li>Check coverage again.</li>
   </ol>
   <p>The coverage is tested by our CI tests and the results are available
     on 
    <a href="https://coveralls.io/github/ocaml/odoc">the coveralls website
    </a>.
   </p><h2 id="ci-tests"><a href="#ci-tests" class="anchor"></a>CI tests</h2>
   <p>Odoc is tested by <a href="https://ci.ocamllabs.io/">ocaml-ci</a>
     and by github workflows. One of these does a coverage build too,
     so we have up-to-date coverage stats on 
    <a href="https://coveralls.io/github/ocaml/odoc">Coveralls</a>.
   </p>
   <p>The tests cover esy and opam builds on Windows, MacOS and Linux,
     and the linux tests cover all supported versions of OCaml. We strive
     to retain compatibility back as far as we can -- currently 4.02 
    -- which is important for supporting docs.ocaml.org.
   </p>
   <h2 id="project-structure">
    <a href="#project-structure" class="anchor"></a>Project structure
   </h2>
   <p>odoc is divided into several sub-libraries, each of which is found
     under <code>src/</code>.
   </p><p>The directories are:</p>
   <ul>
    <li>
     <a href="https://github.com/ocaml/odoc/tree/master/src/odoc">odoc/</a>
      - The overall <code>odoc</code> command-line tool.
    </li>
    <li>
     <a href="https://github.com/ocaml/odoc/tree/master/src/parser">parser/
     </a> - The parser for ocamldoc syntax (
     <a href="deps/stdlib/Odoc_parser/index.html">documentation</a>)
    </li>
    <li>
     <a href="https://github.com/ocaml/odoc/tree/master/src/model">model/</a>
      - Representation of OCaml source (
     <a href="odoc_model/Odoc_model/index.html">documentation</a>)
    </li>
    <li>
     <a href="https://github.com/ocaml/odoc/tree/master/src/model_desc">
      model_desc/
     </a> - Used for pretty-printing of 
     <a href="odoc_model/Odoc_model/index.html"><code>Odoc_model</code></a>
      types (
     <a href="odoc_model_desc/Odoc_model_desc/index.html">documentation</a>
     )
    </li>
    <li>
     <a href="https://github.com/ocaml/odoc/tree/master/src/loader">loader/
     </a> - Responsible for loading cmti, cmt and cmi files (
     <a href="odoc_loader/Odoc_loader/index.html">documentation</a>)
    </li>
    <li>
     <a href="https://github.com/ocaml/odoc/tree/master/src/xref2">xref2/</a>
      - Resolution and expansion (
     <a href="odoc_xref2/Odoc_xref2/index.html">documentation</a>)
    </li>
    <li>
     <a href="https://github.com/ocaml/odoc/tree/master/src/document">
      document/
     </a> - Translates from 
     <a href="odoc_model/Odoc_model/index.html"><code>Odoc_model</code></a>
      types into 
     <a href="odoc_document/Odoc_document/Types/Page/index.html#type-t">
      generic documentation IR
     </a> (<a href="odoc_document/Odoc_document/index.html">documentation</a>
     )
    </li>
    <li>
     <a href="https://github.com/ocaml/odoc/tree/master/src/vendor">vendor/
     </a> - Third-party software (highlight.js) and there are 3 directories
      for the different output formats:
    </li>
   </ul>
   <ul>
    <li>
     <a href="https://github.com/ocaml/odoc/tree/master/src/html/">html/</a>
      - The HTML renderer (
     <a href="odoc_html/Odoc_html/index.html">documentation</a>)
    </li>
    <li>
     <a href="https://github.com/ocaml/odoc/tree/master/src/latex/">latex/
     </a> - The LaTeX renderer (
     <a href="odoc_latex/Odoc_latex/index.html">documentation</a>)
    </li>
    <li>
     <a href="https://github.com/ocaml/odoc/tree/master/src/manpage/">
      manpage/
     </a> - The man-page renderer (
     <a href="odoc_manpage/Odoc_manpage/index.html">documentation</a>
     )
    </li>
   </ul>
   <p>The source for the main CLI binary is 
    <a href="https://github.com/ocaml/odoc/blob/master/src/odoc/bin/main.ml">
     src/odoc/bin/main.ml
    </a>
   </p>
  </div>
 </body>
</html>